import streamlit as st
import pandas as pd
import requests
from datetime import date, timedelta, datetime
import plotly.express as px
import pytz

# --- Configuration ---
st.set_page_config(page_title="Iberian Energy Prices", page_icon="‚ö°", layout="wide")

# --- üîó URL PARAMETER HANDLING ---
qp = st.query_params

def get_param(key, default_val, type_func):
    try:
        if key in qp:
            return type_func(qp[key])
        return default_val
    except:
        return default_val

# Defaults
default_lang_idx = get_param("lang_idx", 2, int)
default_vat = get_param("vat", 23.0, float)
default_comm_fee = get_param("comm_fee", 0.025, float)
default_grid_type = get_param("grid_type", "Fixed", str)
default_grid_fixed = get_param("grid_fixed", 0.060, float)
default_grid_p1 = get_param("grid_p1", 0.100, float)
default_grid_p2 = get_param("grid_p2", 0.040, float)
default_grid_p3 = get_param("grid_p3", 0.010, float)
default_show_fixed_comp = get_param("show_fixed_comp", False, lambda x: x.lower() == 'true')
default_fixed_val = get_param("fixed_val", 0.120, float)

# --- üåç TRANSLATION ENGINE ---
LANGUAGES = {
    "English": {
        "title": "‚ö° Iberian Electricity Prices",
        "config_title": "‚öôÔ∏è Configuration & Tariff",
        "tab_daily": "üìÖ Daily View",
        "tab_history": "üìà 30-Day Trend",
        "select_date": "Select Date",
        "country": "Country",
        "settings": "Settings",
        "show_raw": "Show Raw Market Price (‚Ç¨/MWh)",
        "comp_toggle": "Compare with Fixed Rate",
        "fixed_input": "Your Fixed Energy Price (‚Ç¨/kWh)",
        "taxes": "Taxes & Fees",
        "vat": "VAT / IVA (%)",
        "comm_fee_label": "Commercial Margin (‚Ç¨/kWh)",
        "comm_help": "Fee charged by your retailer to manage the contract. Usually 0.01 - 0.03 ‚Ç¨.",
        "grid_fee_label": "Grid Access Fees",
        "grid_help": "Cost to maintain cables and transport energy. Can be fixed or variable.",
        "grid_type_fixed": "Fixed",
        "grid_type_var": "Variable (Time-of-Use)",
        "grid_fixed_input": "Fixed Grid Fee (‚Ç¨/kWh)",
        "grid_p1_input": "Peak Fee (Punta) (‚Ç¨/kWh)",
        "grid_p2_input": "Standard Fee (Llano) (‚Ç¨/kWh)",
        "grid_p3_input": "Off-Peak Fee (Valle) (‚Ç¨/kWh)",
        "calc_title": "‚è±Ô∏è Plan Your Usage",
        "calc_appliance": "Select Appliance",
        "calc_custom": "Custom Power...",
        "calc_power": "Power (Watts)",
        "calc_duration": "Duration (Hours)",
        "calc_cost": "Estimated Cost",
        "calc_start": "Best Start:",
        "view_table": "View Detailed Data Table",
        "table_title": "üìã Hourly Data",
        "download_csv": "üì• Download Data as CSV",
        "daily_summary": "Daily Summary",
        "avg_price": "Average Price",
        "min_price": "Lowest Price",
        "max_price": "Highest Price",
        "your_rate": "Your Fixed Rate",
        "tax_applied": "Tax Applied",
        "price_axis": "Price",
        "hour_axis": "Start Hour",
        "interval_col": "Time Interval",
        "price_col": "Price",
        "base_col": "Base Market Price",
        "date_axis": "Date",
        "now_label": "NOW",
        "verdict_good": "‚úÖ Great time to use energy!",
        "verdict_bad": "‚ùå Expensive! Wait if possible.",
        "verdict_avg": "‚öñÔ∏è Average Price.",
        "verdict_fixed_win": "‚úÖ Cheaper than your Fixed Rate!",
        "verdict_fixed_loss": "‚ùå More expensive than Fixed Rate.",
        "zone_valle": "Off-Peak",
        "zone_llano": "Standard",
        "zone_punta": "Peak",
        "data_unavailable": "‚ö†Ô∏è Data not available for",
        "raw_info": "Showing raw market data in ‚Ç¨/MWh. Taxes and tariffs are hidden.",
        "hist_title": "Price Evolution (Last 30 Days)",
        "hist_avg_note": "Showing daily average prices.",
        "explain_title": "üìù Price Breakdown",
        "explain_formula": "Calculation Formula",
        "explain_market": "Market Price",
        "explain_comm": "Comm. Margin",
        "explain_grid": "Grid Fees",
        "explain_tax": "VAT"
    },
    "Espa√±ol": {
        "title": "‚ö° Precio de la Luz (OMIE)",
        "config_title": "‚öôÔ∏è Configuraci√≥n y Tarifa",
        "tab_daily": "üìÖ Vista Diaria",
        "tab_history": "üìà Tendencia 30 D√≠as",
        "select_date": "Seleccionar Fecha",
        "country": "Pa√≠s",
        "settings": "Configuraci√≥n",
        "show_raw": "Ver Precio Mercado (‚Ç¨/MWh)",
        "comp_toggle": "Comparar con Tarifa Fija",
        "fixed_input": "Precio Energ√≠a Fijo (‚Ç¨/kWh)",
        "taxes": "Impuestos y Peajes",
        "vat": "IVA (%)",
        "comm_fee_label": "Margen Comercial (‚Ç¨/kWh)",
        "comm_help": "Coste de gesti√≥n de la comercializadora. Suele ser 0.01 - 0.03 ‚Ç¨.",
        "grid_fee_label": "Peajes de Acceso",
        "grid_help": "Coste de redes y transporte. Puede ser fijo o variable.",
        "grid_type_fixed": "Fijo",
        "grid_type_var": "Variable (Horario)",
        "grid_fixed_input": "Peaje Fijo (‚Ç¨/kWh)",
        "grid_p1_input": "Peaje Punta (P1) (‚Ç¨/kWh)",
        "grid_p2_input": "Peaje Llano (P2) (‚Ç¨/kWh)",
        "grid_p3_input": "Peaje Valle (P3) (‚Ç¨/kWh)",
        "calc_title": "‚è±Ô∏è Planificador de Consumo",
        "calc_appliance": "Elegir Electrodom√©stico",
        "calc_custom": "Potencia Personalizada...",
        "calc_power": "Potencia (W)",
        "calc_duration": "Duraci√≥n (Horas)",
        "calc_cost": "Coste Estimado",
        "calc_start": "Mejor Hora:",
        "view_table": "Ver Tabla de Datos",
        "table_title": "üìã Datos Horarios",
        "download_csv": "üì• Descargar CSV",
        "daily_summary": "Resumen Diario",
        "avg_price": "Precio Medio",
        "min_price": "M√≠nimo",
        "max_price": "M√°ximo",
        "your_rate": "Tu Tarifa Fija",
        "tax_applied": "Impuesto Aplicado",
        "price_axis": "Precio",
        "hour_axis": "Hora Inicio",
        "interval_col": "Intervalo Horario",
        "price_col": "Precio",
        "base_col": "Precio Base Mercado",
        "date_axis": "Fecha",
        "now_label": "AHORA",
        "verdict_good": "‚úÖ ¬°Buen momento!",
        "verdict_bad": "‚ùå Caro. Espera si puedes.",
        "verdict_avg": "‚öñÔ∏è Precio Normal.",
        "verdict_fixed_win": "‚úÖ ¬°M√°s barato que tu Fija!",
        "verdict_fixed_loss": "‚ùå M√°s caro que tu Fija.",
        "zone_valle": "Valle",
        "zone_llano": "Llano",
        "zone_punta": "Punta",
        "data_unavailable": "‚ö†Ô∏è Datos no disponibles para",
        "raw_info": "Mostrando datos crudos en ‚Ç¨/MWh. Sin impuestos ni peajes.",
        "hist_title": "Evoluci√≥n de Precios (√öltimos 30 D√≠as)",
        "hist_avg_note": "Mostrando precios medios diarios.",
        "explain_title": "üìù Desglose del Precio",
        "explain_formula": "F√≥rmula de C√°lculo",
        "explain_market": "Precio Mercado",
        "explain_comm": "Margen Comer.",
        "explain_grid": "Peajes",
        "explain_tax": "IVA"
    },
    "Portugu√™s": {
        "title": "‚ö° Pre√ßo da Eletricidade (OMIE)",
        "config_title": "‚öôÔ∏è Configura√ß√£o e Tarifa",
        "tab_daily": "üìÖ Vis√£o Di√°ria",
        "tab_history": "üìà Tend√™ncia 30 Dias",
        "select_date": "Selecionar Data",
        "country": "Pa√≠s",
        "settings": "Configura√ß√µes",
        "show_raw": "Ver Pre√ßo de Mercado (‚Ç¨/MWh)",
        "comp_toggle": "Comparar com Taxa Fixa",
        "fixed_input": "Seu Pre√ßo Fixo (‚Ç¨/kWh)",
        "taxes": "Impostos e Taxas",
        "vat": "IVA (%)",
        "comm_fee_label": "Margem Comercial (‚Ç¨/kWh)",
        "comm_help": "Custo de gest√£o do comercializador. Geralmente 0.01 - 0.03 ‚Ç¨.",
        "grid_fee_label": "Tarifas de Acesso √†s Redes",
        "grid_help": "Custo de transporte e manuten√ß√£o da rede. Pode ser fixo ou vari√°vel.",
        "grid_type_fixed": "Fixo",
        "grid_type_var": "Vari√°vel (Hor√°rio)",
        "grid_fixed_input": "Acesso Fixo (‚Ç¨/kWh)",
        "grid_p1_input": "Taxa Ponta (P1) (‚Ç¨/kWh)",
        "grid_p2_input": "Taxa Cheias (P2) (‚Ç¨/kWh)",
        "grid_p3_input": "Taxa Vazio (P3) (‚Ç¨/kWh)",
        "calc_title": "‚è±Ô∏è Planear Consumo",
        "calc_appliance": "Escolher Eletrodom√©stico",
        "calc_custom": "Pot√™ncia Personalizada...",
        "calc_power": "Pot√™ncia (W)",
        "calc_duration": "Dura√ß√£o (Horas)",
        "calc_cost": "Custo Estimado",
        "calc_start": "Melhor In√≠cio:",
        "view_table": "Ver Tabela de Dados",
        "table_title": "üìã Dados Hor√°rios",
        "download_csv": "üì• Baixar CSV",
        "daily_summary": "Resumo Di√°rio",
        "avg_price": "Pre√ßo M√©dio",
        "min_price": "M√≠nimo",
        "max_price": "M√°ximo",
        "your_rate": "Sua Taxa Fixa",
        "price_axis": "Pre√ßo",
        "hour_axis": "Hora In√≠cio",
        "date_axis": "Data",
        "interval_col": "Intervalo Hor√°rio",
        "price_col": "Pre√ßo",
        "base_col": "Pre√ßo Base Mercado",
        "now_label": "AGORA",
        "verdict_good": "‚úÖ Bom momento!",
        "verdict_bad": "‚ùå Caro. Espere se puder.",
        "verdict_avg": "‚öñÔ∏è Pre√ßo M√©dio.",
        "verdict_fixed_win": "‚úÖ Mais barato que a Fixa!",
        "verdict_fixed_loss": "‚ùå Mais caro que a Fixa.",
        "zone_valle": "Vazio",
        "zone_llano": "Cheias",
        "zone_punta": "Ponta",
        "data_unavailable": "‚ö†Ô∏è Dados n√£o dispon√≠veis para",
        "raw_info": "Mostrando dados brutos em ‚Ç¨/MWh. Sem impostos ou taxas.",
        "hist_title": "Evolu√ß√£o de Pre√ßos (√öltimos 30 Dias)",
        "hist_avg_note": "Mostrando pre√ßos m√©dios di√°rios.",
        "explain_title": "üìù Composi√ß√£o do Pre√ßo",
        "
